var ConfigFeatureView=function(){var instance,_features,_displayTargetId,_displayTarget,_initAngle,_step,_numAngleStep,_templateId,_fpBaseSize,_parentViewSize,$positionsWrapper,$descriptionWrapper,$slideImages,_descriptionsId="fp-descriptions",_fpIds=[],_points={},_dscCnt=0,_dscZindex=0,_dscSlideId="",_dscSlideTimer=null,DSC_SLIDE_SPEED=.3,DSC_SLIDE_SPAN=2.5;function ConfigFeatureView(options){return instance||(instance=this,_displayTargetId=(options=options||{}).displayTargetId,_displayTarget=$(_displayTargetId),_templateId=options.templateId,_parentViewSize=options.parentViewSize,_fpBaseSize=options.baseSize,$positionsWrapper=$("<div/>").attr("id","fp-positions"),$descriptionWrapper=$("<div/>").attr("id",_descriptionsId)),init(options),instance}function init(options){_features=options.features,_initAngle=options.angle,_parentViewSize=options.parentViewSize,_step=options.step,_numAngleStep=options.numAngleStep,_fpIds=[],_points={},$positionsWrapper.empty(),$descriptionWrapper.empty(),_features&&(_points=function(){var $funcPointBase=$("<span/>"),tmplDisplayObj=[],fragment=document.createDocumentFragment();for(var fpObjName in _features)if(_features.hasOwnProperty(fpObjName)){var $fpObj=$funcPointBase.clone(!0),fp=_features[fpObjName];if(fp.visible){tmplDisplayObj.push(fp),_fpIds.push(fp.feature_id);var adjustedPoints=adjustPoints(fp.positions),x=(fp.adjustedPositions=adjustedPoints)[_initAngle].x,y=adjustedPoints[_initAngle].y;isHide(x,y)&&($fpObj.hide(),y=x=0),$fpObj.attr("id",fp.feature_id).css({top:y,left:x}),$fpObj.on("click",function(){0===$descriptionWrapper.children().size()&&(_displayTarget.append($descriptionWrapper),$(_templateId).tmpl(_points.tmplDisplayObj).appendTo($descriptionWrapper));var id=$(this).attr("id"),$description=$("#"+_descriptionsId);$description.children().hide(),$description.find("#"+id).show(),function(id){if(_dscSlideId!=id){_dscSlideId=id;var $description=$("#"+_descriptionsId);$slideImages=$description.find("#"+id).find("img"),_dscZindex=_dscCnt=0,$slideImages.css({"z-index":0}).hide(),$slideImages.eq(0).css({"z-index":1}).show(),clearInterval(_dscSlideTimer),$slideImages.length<=1||(_dscSlideTimer=setInterval(function(){!function(num){var prev=_dscCnt;1e3<++_dscZindex&&($slideImages.css({"z-index":0}),$slideImages.eq(prev).css({"z-index":1}),_dscZindex=2),$slideImages.eq(num).css({"z-index":_dscZindex}).stop().hide().fadeTo(1e3*DSC_SLIDE_SPEED,1),_dscCnt=num}(_dscCnt+1==$slideImages.length?0:_dscCnt+1)},1e3*DSC_SLIDE_SPAN+1e3*DSC_SLIDE_SPEED))}}(id)}),$(fragment).append($fpObj)}}return{fragment:fragment,tmplDisplayObj:tmplDisplayObj}}(),$positionsWrapper.append(_points.fragment),_displayTarget.append($positionsWrapper))}function adjustPoints(fpPositions){for(var reductionRatioW=_parentViewSize.width/_fpBaseSize.stageW,reductionRatioH=_parentViewSize.height/_fpBaseSize.stageH,newPositions=[],i=0;i<_numAngleStep;i++){var x=fpPositions[i*_step].x,y=fpPositions[i*_step].y;0!==x&&!x||(x*=reductionRatioW),0!==y&&!y||(y*=reductionRatioH);var position={x:x,y:y};newPositions.push(position)}return newPositions}function isHide(x,y){return 0!==x&&!x||0!==y&&!y}return ConfigFeatureView.getInstance=function(){return instance=instance||new ConfigFeatureView},ConfigFeatureView.prototype={init:init,changeAngle:function(angle){if(0!==_fpIds.length)for(var i=0;i<_fpIds.length;i++){var point=_features[_fpIds[i]].adjustedPositions[angle],x=point.x,y=point.y,$fpObj=$("#"+_fpIds[i]);isHide(x,y)?($fpObj.hide(),y=x=0):$fpObj.show(),$fpObj.css({top:y,left:x})}},hideAllDescriptions:function(){$("#"+_descriptionsId).children().hide(),clearInterval(_dscSlideTimer),_dscSlideId=""}},ConfigFeatureView}();