var PreLoader=function(){var self,_numItems,_numItemsLoaded,_requestedItems,_items,_materials,_parentStage,_maxConnections=6,_cancelFlg=!1,_loadedManager=[],_layerNum=0;function PreLoader(options){options=options||{},self=this,init(),_materials=options.materials,_layerNum=options.layerNum,_parentStage=options.parentStage}function init(){_requestedItems=[],_items=[],_materials=[],_cancelFlg=!(_maxConnections=6),{},_loadedManager=[],_layerNum=_numItemsLoaded=_numItems=0}function _loadNext(){if(!_isCanceled()&&_hasNext()){var item=_items.splice(0,1)[0],src=item.src,id=item.id,angle=item.angle,$targetImg=$("#"+id);if(0===$targetImg.size()){var $targetWrapper=$(_parentStage.find(".angle"+angle).get(0)),$newImg=$("<img />").addClass("layer"+item.layer).addClass("drawTarget").attr("draggable",!1).attr("id",id).css("zIndex",100*angle+item.layer);_addImgLoadEventListner($newImg,item),$targetWrapper.append($newImg),$newImg.attr("src",src),_requestedItems.push($newImg)}else if(item.src===$targetImg.attr("src")){if($targetImg.css("visibility",""),_numItemsLoaded++,_addLoadedManager(item),0===_requestedItems.length&&_isAllLoaded())return void _dispatchAllLoaded();_hasNext()&&_loadNext()}else _addImgLoadEventListner($targetImg,item),$targetImg.attr("src",src),_requestedItems.push($targetImg)}}function _addImgLoadEventListner(targetImg,item){targetImg.on("load",item,_imgLoadHandler),targetImg.on("error",item,_imgErrorHandler)}function _removeLoadEventListner(targetImg){targetImg.off("load",_imgLoadHandler),targetImg.off("error",_imgErrorHandler)}function _imgLoadHandler(event){var item=event.data;if(_isCurrentMaterial(item.materialPath)&&(_numItemsLoaded++,_removeRequestedItems(this),_addLoadedManager(item),_removeLoadEventListner($(this)),function(event,loadedImg){if(_isCanceled())return;var e=jQuery.Event("fileload",{item:event.data,imgData:loadedImg});$(self).trigger(e)}(event,this),$("#"+item.id).css("visibility","")),_isAllLoaded())_dispatchAllLoaded();else if(_hasNext())for(var requestNum=_maxConnections-_requestedItems.length,i=0;i<requestNum&&_hasNext();i++)_loadNext()}function _imgErrorHandler(event){var item=event.data;_isCurrentMaterial(item.materialPath)&&(_numItemsLoaded++,_removeRequestedItems(this),_addLoadedManager(item),_removeLoadEventListner($(this)),this.removeAttribute("src"),$(this).css("visibility","hidden")),_isAllLoaded()?_dispatchAllLoaded():_hasNext()&&_loadNext()}function _isAllLoaded(){return _numItems===_numItemsLoaded}function _dispatchAllLoaded(){$(self).trigger("allFileload")}function _removeRequestedItems(loadedImg){if(loadedImg)for(var i=0;i<_requestedItems.length;i++){if(_requestedItems[i].get(0)==loadedImg)return void _requestedItems.splice(i,1)}}function _isCanceled(){return!!_cancelFlg}function _hasNext(){return 0!==_items.length}function _addLoadedManager(item){var angle=item.angle,mId=item.materialId;_loadedManager[angle]instanceof Array?_loadedManager[angle].push(mId):_loadedManager[angle]=[mId],_loadedManager[angle].length==_layerNum&&function(angle){var event=jQuery.Event("singleAngleLoad",{angle:angle});$(self).trigger(event)}(angle)}function _isCurrentMaterial(materialPath){for(var i=0;i<_materials.length;i++)if(_materials[i].material===materialPath)return!0;return!1}return PreLoader.prototype={init:init,cancelLoad:function(){_cancelFlg=!0},setMaxConnections:function(value){_maxConnections=value},loadManifest:function(manifest){_cancelFlg=!1,_numItemsLoaded=0,_numItems=manifest.length,_items=manifest,_requestedItems.length=0;for(var l=_items.length,i=0;i<l;i++){if(0===_items.length)return;if(_requestedItems.length>=_maxConnections)return;if(_isCanceled())return;_loadNext()}},getNextShowAngle:function(currentIndex,rotationDirection,_numAngleStep,layerNum){var showTargetIndex=currentIndex;function getNextIndex(index,rotationDirection){return rotationDirection?index==_numAngleStep-1?index=0:index++:0===index?index=_numAngleStep-1:index--,index}for(var i=0;i<_numAngleStep;i++){showTargetIndex=getNextIndex(showTargetIndex,rotationDirection);var showtarget=_loadedManager[showTargetIndex];if(showtarget&&showtarget.length===layerNum)return showTargetIndex}return currentIndex},setOptions:function(options){_materials=options.materials,_layerNum=options.layerNum,_parentStage=options.parentStage}},PreLoader}();