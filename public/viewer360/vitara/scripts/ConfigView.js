var ConfigView=function(){var imgIndexArry,seqUnitArry,loader=null,_loadingIndicator=null;function ConfigView(options){options=options||{},_loadingIndicator=_loadingIndicator||$(options.loadingIndicator);var _displayTarget=$(options.displayTarget),_displayStage=_displayTarget.find(".stage"),_tmpDisplayTarget=_displayTarget.find(".tmp"),_numAngles=options.numAngles,_numAngleStep=options.numAngleStep,_angleStep=Math.round(_numAngles/_numAngleStep),_materialDirPath=options.materialDirPath,_currentLayers=[],_newLayers=[],_currentAngle=0,_layerNum=0,_initBaseFlg=!1,_showTargetInitFlg=!1;this.getDisplayTarget=function(){return _displayTarget},this.getDisplayStage=function(){return _displayStage},this.getTmpDisplayTarget=function(){return _tmpDisplayTarget},this.getNumAngleStep=function(){return _numAngleStep},this.getAngleStep=function(){return _angleStep},this.getMaterialDirPath=function(){return _materialDirPath},this.getCurrentLayers=function(){return _currentLayers},this.getNewLayers=function(){return _newLayers},this.getCurrentAngle=function(){return _currentAngle},this.getLayerNum=function(){return _layerNum},this.isInitBase=function(){return _initBaseFlg},this.isInitTarget=function(){return _showTargetInitFlg},this.setCurrentLayers=function(cL){_currentLayers=cL},this.setNewLayers=function(nL){_newLayers=nL},this.setCurrentAngle=function(cA){_currentAngle=cA},this.setLayerNum=function(lN){_layerNum=lN},this.setInitBaseFlg=function(iF){_initBaseFlg=iF},this.setShowTargetInitFlg=function(sTIF){_showTargetInitFlg=sTIF},this.getDisplayTargetSize=function(){return{width:_displayTarget.width(),height:_displayTarget.height()}}}function _divisionArr(arry){var result=[],centerIndex=Math.ceil(arry.length/2);return result.push(arry.slice(0,centerIndex)),result.push(arry.slice(centerIndex)),result}return Array.prototype.indexOf||(Array.prototype.indexOf=function(searchElement){"use strict";if(null==this)throw new TypeError;var t=Object(this),len=t.length>>>0;if(0==len)return-1;var n=0;if(1<arguments.length&&((n=Number(arguments[1]))!=n?n=0:0!==n&&n!=1/0&&n!=-1/0&&(n=(0<n||-1)*Math.floor(Math.abs(n)))),len<=n)return-1;for(var k=0<=n?n:Math.max(len-Math.abs(n),0);k<len;k++)if(k in t&&t[k]===searchElement)return k;return-1}),ConfigView.prototype={init:function(){0===_loadingIndicator.children().size()&&this._createLoadingIndicator()},createSelection:function(target,category,template){for(var checkRegExp=new RegExp("_I$"),groupIndex=0;groupIndex<=category.groups.length-1;groupIndex++){var subItems=jsonPath(category.groups[groupIndex].items,"$.[?(@.subItem)]");for(var subIndex in subItems)if(subItems.hasOwnProperty(subIndex)){var mainItem=jsonPath(category.groups[groupIndex].items,"$.[?(@.item_id =='"+subItems[subIndex].subItem+"')]");mainItem&&((mainItem=mainItem[0]).subMenu||(mainItem.subMenu=[]),subItems[subIndex].item_id!=mainItem.item_id&&mainItem.subMenu.push(subItems[subIndex]))}var group=category.groups[groupIndex];if("radio"!=group.type)for(var selectedItems=jsonPath(group.items,"$.[?(@.checked==false)]"),i=0;i<selectedItems.length;i++)checkRegExp.test(selectedItems[i].item_id)||(selectedItems[i].item_id=selectedItems[i].item_id+"_I");$(template).tmpl(category.groups[groupIndex]).appendTo(target)}},createBaseImgObjWrapper:function(materials,self){var numAngleStep=self.getNumAngleStep();this.setLayerNum(materials.length);for(var $baseWrapperObj=$("<div/>"),fragment=document.createDocumentFragment(),$baseImgObj=$("<img />").addClass("drawTarget").attr("draggable",!1),i=0;i<numAngleStep;i++){for(var $wrapperObj=$baseWrapperObj.clone(!0).addClass("angle"+i).css("visibility","hidden"),j=0;j<materials.length;j++){var materialId=this._createMaterialId(materials[j].material),$img=$baseImgObj.clone(!0);$img.css("zIndex",100*i+materials[j].layer),$img.attr("id",i+"-"+materialId),$img.addClass("layer"+materials[j].layer),$wrapperObj.append($img)}$(fragment).append($wrapperObj)}self.getDisplayStage().append(fragment),this.setInitBaseFlg(!0)},preloadManager:function(materials){this.isInitBase()||this.createBaseImgObjWrapper(materials,this),this._showIndicator(),null!=loader&&this._closeLoader(),this.setShowTargetInitFlg(!1),this._initLoader(materials),this.setLayerNum(materials.length);var manifestAndId=this._createManifest(materials,this.getCurrentAngle()),manifest=manifestAndId.manifest,nL=this.getNewLayers();nL&&this.setCurrentLayers(nL),this.setNewLayers(manifestAndId.layers);var hiddenTargetLayers=this._gethidenTargetLayers(this.getNewLayers());this._cloneVisibleAngleImgs(),loader.loadManifest(manifest),this._hiddenLayers(hiddenTargetLayers)},cancelLoad:function(){try{loader.cancelLoad(),this._closeLoader()}catch(e){}},showStage:function(){this.getDisplayStage().parent().show()},hideStage:function(){this.getDisplayStage().parent().hide()},_showIndicator:function(){_loadingIndicator.show(),this._removeRotationListners()},_hideIndicator:function(){_loadingIndicator.hide(),this._addRotationListners()},_removeRotationListners:function(){var displayTarget=this.getDisplayStage();displayTarget.off("mousedown touchstart","div"),displayTarget.off("mousemove.move touchmove","div"),displayTarget.off("mouseup touchend")},_createManifest:function(materials,angleSeq){for(var m=[],layers=[],i=0;i<materials.length;i++){layers.push(materials[i].layer);var materialId=this._createMaterialId(materials[i].material),path=this._getImgPath(materials[i].material,angleSeq,materials[i].layer),baseObj={};baseObj.src=path,baseObj.id=angleSeq+"-"+materialId,baseObj.angle=angleSeq,baseObj.materialId=materialId,baseObj.layer=materials[i].layer,baseObj.materialPath=materials[i].material,m.push(baseObj)}return{manifest:m,layers:layers}},_getImgPath:function(material,angleIndex,layerIndex){var filename_ext="_",materialDirPath=this.getMaterialDirPath();if(angleIndex=angleIndex*this.getAngleStep()+1,2!=String(angleIndex).length)for(var j=0;j<2-String(angleIndex).length;j++)filename_ext+="0";return filename_ext+=String(angleIndex),0===layerIndex?materialDirPath+material+"/"+material+filename_ext+".jpg":materialDirPath+material+"/"+material+filename_ext+".png"},_cloneVisibleAngleImgs:function(){this._removeTempAngleImgs();var $visibleImgs=$("#angle"+this.getCurrentAngle()).clone(!1).children(),tmpDisplayTarget=this.getTmpDisplayTarget();$visibleImgs.removeAttr("id"),tmpDisplayTarget.append($visibleImgs).show(),this._hideVisibleAngleImgs()},_removeTempAngleImgs:function(){this.getTmpDisplayTarget().hide().empty()},_hideVisibleAngleImgs:function(){$("#angle"+this.getCurrentAngle()).css("visibility","hidden")},_initLoader:function(materials){loader?(loader.init(),loader.setOptions({materials:materials,layerNum:materials.length,parentStage:this.getDisplayStage()})):(loader=new PreLoader({materials:materials,layerNum:materials.length,parentStage:this.getDisplayStage()})).setMaxConnections(6);var data={self:this,materials:materials};$(loader).on("loadStart",this._handleLoadStart),$(loader).on("fileload",this._handleFileLoad),$(loader).on("singleAngleLoad",this,this._handleSingleAngleLoad),$(loader).on("allFileload",data,this._handleComplete),$(loader).on("error",this._handleError)},_handleLoadStart:function(){},_handleFileLoad:function(event){},_handleSingleAngleLoad:function(e){var event=jQuery.Event("singleAngleLoad",e),self=e.data;$(self).trigger(event)},_handleComplete:function(e){var data=e.data,self=data.self;self.isInitTarget()?self._allCompleteHandler(e):self._initAngleImgsLoadedHandler(e,data.materials)},_handleError:function(){},_allCompleteHandler:function(event){},_initAngleImgsLoadedHandler:function(event,materials){this._hideIndicator();var manifest=[];this.getDisplayStage().find(".angle"+this.getCurrentAngle()).css("visibility","visible"),this._removeTempAngleImgs(),this.setShowTargetInitFlg(!0);for(var numAngleStep=this.getNumAngleStep(),loadWaitingArry=this._createWaitingArry(numAngleStep),index=loadWaitingArry.indexOf(this.getCurrentAngle()),i=1;i<loadWaitingArry.length;i++){++index==numAngleStep&&(index=0);var m=this._createManifest(materials,loadWaitingArry[index]);manifest=manifest.concat(m.manifest)}loader.loadManifest(manifest)},_addRotationListners:function(){var $wrappers,step,stepX,preWrapperObj,nextWrapperObj,nIndex,self=this,numAngleStep=this.getNumAngleStep(),displayTarget=this.getDisplayStage();function mousemoveHandler(e){e.preventDefault();var newStep,index=$wrappers.index(preWrapperObj);if("touchmove"==e.type){var touch=e.originalEvent.touches[0];newStep=Math.round(touch.pageX/stepX)}else newStep=Math.round(e.pageX/stepX);step<newStep&&0!==newStep?(nIndex=loader.getNextShowAngle(index,!0,numAngleStep,self.getLayerNum()),nextWrapperObj=$wrappers.eq(nIndex),toggleAngle(preWrapperObj,nextWrapperObj),preWrapperObj=nextWrapperObj):newStep<step&&0!==newStep&&(nIndex=loader.getNextShowAngle(index,!1,numAngleStep,self.getLayerNum()),nextWrapperObj=$wrappers.eq(nIndex),toggleAngle(preWrapperObj,nextWrapperObj),preWrapperObj=nextWrapperObj),step=newStep,self.setCurrentAngle(nIndex),self._dispatchAngleChange(nIndex),newStep=index=null}function mouseupHandler(){displayTarget.off("mousemove.move touchmove"),displayTarget.off("mouseup touchend"),nextWrapperObj=preWrapperObj=stepX=step=$wrappers=null}function toggleAngle(prevObj,nextObj){$(prevObj).css("visibility","hidden"),$(nextObj).css("visibility","visible")}displayTarget.on("mousedown touchstart","div",function(e){if(e.preventDefault(),displayTarget.on("mousemove.move touchmove","div",mousemoveHandler),displayTarget.on("mouseup touchend",mouseupHandler),preWrapperObj=$(this),$wrappers=displayTarget.find("div"),stepX=$(this).width()/numAngleStep,"touchstart"==e.type){var touch=e.originalEvent.touches[0];touch.pageX,step=Math.round(touch.pageX/stepX)}else e.pageX,step=Math.round(e.pageX/stepX)})},_closeLoader:function(){$(loader).off("loadStart",this._handleLoadStart),$(loader).off("fileload",this._handleFileLoad),$(loader).off("singleAngleLoad",this._handleSingleAngleLoad),$(loader).off("allFileload",this._handleComplete),$(loader).off("error",this._handleError)},_createLoadingIndicator:function(){var $progressPanel=_loadingIndicator,$progress=$("<div/>");$progress.attr("id","floatingBarsG");for(var i=1;i<=8;i++){var $d=$("<div/>"),id="rotateG_0"+i;$d.attr("id",id),$d.addClass("blockG"),$progress.append($d)}$progressPanel.append($progress)},_createMaterialId:function(material){for(var itemIds=material.split("-"),materialId="",i=0;i<2;i++){var categoryNames=itemIds[i].split("_");materialId+=i?"_"+categoryNames[0]:categoryNames[0]}return materialId},_gethidenTargetLayers:function(newLayers){for(var hidenTargetLayers=this.getCurrentLayers().concat([]),i=0;i<newLayers.length;i++){var index=hidenTargetLayers.indexOf(newLayers[i]);0<=index&&hidenTargetLayers.splice(index,1)}return hidenTargetLayers},_hiddenLayers:function(layers){for(var i=0;i<layers.length;i++)$(".layer"+layers[i]).css("visibility","hidden")},_dispatchAngleChange:function(angle){if(0<=angle){var event=jQuery.Event("angleChange",{angle:angle});$(this).trigger(event)}},_createWaitingArry:function(seq){imgIndexArry=[],seqUnitArry=[];for(var numSeq=seq,waitingArry=[],seqUnitOdd=[],seqUnitEven=[],i=0;i<numSeq;i++)imgIndexArry.push(i);for(;seqUnitArry.length<4;)this._recombineArr(imgIndexArry);for(var j=0;j<seqUnitArry.length;j++)j%2==0?seqUnitEven.push(seqUnitArry[j]):seqUnitOdd.push(seqUnitArry[j]);for(seqUnitArry=seqUnitEven.concat(seqUnitOdd);waitingArry.length<numSeq;)for(var k=0;k<4;k++)void 0!==seqUnitArry[k][0]&&waitingArry.push(seqUnitArry[k].shift());return waitingArry},_recombineArr:function(arry){var result=[];if(arry[0]instanceof Array)for(var i=0;i<arry.length;i++){var newArry=_divisionArr(arry[i]);result=result.concat(newArry)}else result=this._divisionArr(arry);imgIndexArry=seqUnitArry=result},_divisionArr:_divisionArr,_displayConsole:function(){}},ConfigView}();